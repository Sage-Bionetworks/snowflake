---
name: Test Changes with Cloned DB

on:
    pull_request:
        types: [ synchronize, closed ]

permissions:
    contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:

    test_with_clone:
        runs-on: ubuntu-latest
        if: ${{ !contains(github.event.pull_request.labels.*.name, 'skip_cloning') && github.event.pull_request.state == 'open' }}
        environment: dev
        env:
            # Establish the snowflake account credentials
            SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWSQL_ACCOUNT }}
            SNOWFLAKE_USER: ${{ secrets.SNOWSQL_USER }}
            SNOWFLAKE_PASSWORD: ${{ secrets.SNOWSQL_PWD }}
            
            # Establish the account roles to be used
            SNOWFLAKE_ADMIN_ROLE: "${{ vars.SNOWFLAKE_SYNAPSE_DATA_WAREHOUSE_DATABASE }}_ADMIN"
            SNOWFLAKE_CLONE_ROLE: DATA_ENGINEER

            # Establish the domains
            SNOWFLAKE_DOMAIN_ORIGINAL: ${{ vars.SNOWFLAKE_SYNAPSE_DATA_WAREHOUSE_DATABASE }}
            SNOWFLAKE_DOMAIN_CLONE: "${{ vars.SNOWFLAKE_SYNAPSE_DATA_WAREHOUSE_DATABASE }}_${{ github.head_ref }}"

            # Establish other miscellaneous variables
            SNOWFLAKE_WAREHOUSE: ${{ secrets.SNOWSQL_WAREHOUSE }}
            SNOWFLAKE_SYNAPSE_STAGE_STORAGE_INTEGRATION: ${{ vars.SNOWFLAKE_SYNAPSE_STAGE_STORAGE_INTEGRATION }}
            SNOWFLAKE_SYNAPSE_STAGE_URL: ${{ vars.SNOWFLAKE_SYNAPSE_STAGE_URL }}
            STACK: ${{ vars.STACK }}

        steps:

            ########################################################################################################
            ########################################################################################################
            ############################ ENVIRONMENT SETUP AND CONNECTION CONFIGURATION ############################
            ########################################################################################################
            ########################################################################################################
            - uses: actions/checkout@v4
            - uses: actions/setup-python@v4
              with:
                python-version: '3.10'

            - name: Install python libraries
              shell: bash
              run: |
                  pip install schemachange==3.6.1
                  pip install numpy==1.26.4
                  pip install pandas==1.5.3

            - name: Configure Snowflake connections
              run: |
                # Make a temporary config file for the GH runner
                config_file=$(mktemp)

                # Config file for *ADMIN
                echo 'default_connection_name = "admin"' >> $config_file
                echo '[connections.admin]' >> $config_file
                echo "account = \"${SNOWFLAKE_ACCOUNT}\"" >> $config_file
                echo "user = \"${SNOWFLAKE_USER}\"" >> $config_file
                echo "role = \"${SNOWFLAKE_ADMIN_ROLE}\"" >> $config_file
                echo "password = \"${SNOWFLAKE_PASSWORD}\"" >> $config_file
                echo "warehouse = \"${SNOWFLAKE_WAREHOUSE}\"" >> $config_file
                echo 'authenticator = "SNOWFLAKE"' >> $config_file

                # Write config paths to environment
                echo "SNOWFLAKE_CONFIG_PATH=$config_file" >> $GITHUB_ENV

            - name: Install Snowflake CLI
              uses: Snowflake-Labs/snowflake-cli-action@v1.5
              with:
                default-config-file-path: ${{ env.SNOWFLAKE_CONFIG_PATH }}

            - name: Verify Snowflake CLI installation and connections
              run: |
                snow --version
                snow connection test -c admin

            ########################################################################################################
            ########################################################################################################
            ############################## SETTING UP AND CREATING THE CLONE DATABASE ##############################
            ########################################################################################################
            ########################################################################################################
            - name: Sanitize Clone Name
              run: |
                # Sanitize the clone name. That is, replace all non-alphanumeric characters with an underscore.
                # Then create a new environment variable with the sanitized clone name to use in subsequent steps.
                SNOWFLAKE_DOMAIN_CLONE_SANITIZED="${SNOWFLAKE_DOMAIN_CLONE//[^a-zA-Z0-9_]/_}"
                echo "Clone name has been updated! The clone name will be: ${SNOWFLAKE_DOMAIN_CLONE_SANITIZED}"
                echo "SNOWFLAKE_DOMAIN_CLONE_SANITIZED=${SNOWFLAKE_DOMAIN_CLONE_SANITIZED}" >> $GITHUB_ENV

                # Next, create the environment variable: SNOWFLAKE_SYNAPSE_DATA_WAREHOUSE_DATABASE
                # which schemachange uses to deploy changes to the right database (this is used in the schemachange step)
                echo "SNOWFLAKE_SYNAPSE_DATA_WAREHOUSE_DATABASE=${SNOWFLAKE_DOMAIN_CLONE_SANITIZED}" >> $GITHUB_ENV

            - name: Zero-copy clone the database as ADMIN
              shell: bash
              run: |
                snow sql -q "CREATE OR REPLACE DATABASE ${SNOWFLAKE_DOMAIN_CLONE_SANITIZED} CLONE ${SNOWFLAKE_DOMAIN_ORIGINAL};"

            ########################################################################################################
            ########################################################################################################
            ########################################## MANAGING GRANTS #############################################
            ########################################################################################################
            ########################################################################################################
            - name: Grant USAGE of clone database to DATA_ENGINEER
              shell: bash
              run: |
                snow sql -q "GRANT USAGE ON DATABASE ${SNOWFLAKE_DOMAIN_CLONE_SANITIZED} TO ROLE ${SNOWFLAKE_CLONE_ROLE};"

            - name: Establish full account role name for PROXY_ADMIN
              shell: bash
              run: |
                # The *PROXY_ADMIN account role will be used to manage interschema objects (e.g. tasks, dynamic tables)
                # within the cloned database. First let's create the PROXY_ADMIN account role name and export for immediate use:
                echo "SNOWFLAKE_PROXY_ADMIN_ROLE=${SNOWFLAKE_DOMAIN_CLONE_SANITIZED}_PROXY_ADMIN" >> $GITHUB_ENV

            - name: Create account role PROXY_ADMIN
              shell: bash
              run: |
                # Briefly switch to ACCOUNTADMIN and create the PROXY_ADMIN role
                snow sql -r "ACCOUNTADMIN" -q "CREATE OR REPLACE ROLE ${SNOWFLAKE_PROXY_ADMIN_ROLE};"

            - name: Grant account role PROXY_ADMIN to user SNOWFLAKE_ACCOUNT
              shell: bash
              run: |
                # Briefly switch to ACCOUNTADMIN and grant the PROXY_ADMIN role to service account
                snow sql -r "ACCOUNTADMIN" -q "GRANT ROLE ${SNOWFLAKE_PROXY_ADMIN_ROLE} TO USER DPE_SERVICE;"

            - name: Grant USAGE of clone database to PROXY_ADMIN
              shell: bash
              run: |
                snow sql -q "GRANT USAGE ON DATABASE ${SNOWFLAKE_DOMAIN_CLONE_SANITIZED} TO ROLE ${SNOWFLAKE_PROXY_ADMIN_ROLE};"

            - name: Transfer ownership of current and future tasks and dynamic tables to PROXY_ADMIN
              shell: bash
              run: |
                snow sql -r "SECURITYADMIN" -q "GRANT OWNERSHIP ON ALL DYNAMIC TABLES IN SCHEMA ${SNOWFLAKE_DOMAIN_CLONE_SANITIZED}.SYNAPSE TO ROLE ${SNOWFLAKE_PROXY_ADMIN_ROLE} COPY CURRENT GRANTS;"
                snow sql -r "SECURITYADMIN" -q "GRANT OWNERSHIP ON ALL TASKS IN SCHEMA ${SNOWFLAKE_DOMAIN_CLONE_SANITIZED}.SYNAPSE_RAW TO ROLE ${SNOWFLAKE_PROXY_ADMIN_ROLE} COPY CURRENT GRANTS;"
                snow sql -r "SECURITYADMIN" -q "GRANT OWNERSHIP ON ALL DYNAMIC TABLES IN SCHEMA ${SNOWFLAKE_DOMAIN_CLONE_SANITIZED}.SCHEMACHANGE TO ROLE ${SNOWFLAKE_PROXY_ADMIN_ROLE} COPY CURRENT GRANTS;"
                # For some reason you can't just peacefully transfer ownership for FUTURE objects, you need to explicitly revoke
                # ownership from the previous role.
                # Need to use SECURITYADMIN for future objects because they're technically not owned by the <DOMAIN>_ADMIN role for some reason?? Reasons unclear.
                snow sql -r "SECURITYADMIN" -q "REVOKE OWNERSHIP ON FUTURE DYNAMIC TABLES IN SCHEMA ${SNOWFLAKE_DOMAIN_CLONE_SANITIZED}.SYNAPSE FROM ROLE ${SNOWFLAKE_DOMAIN_ORIGINAL}_PROXY_ADMIN;"
                snow sql -r "SECURITYADMIN" -q "REVOKE OWNERSHIP ON FUTURE TASKS IN SCHEMA ${SNOWFLAKE_DOMAIN_CLONE_SANITIZED}.SYNAPSE_RAW FROM ROLE ${SNOWFLAKE_DOMAIN_ORIGINAL}_PROXY_ADMIN;"
                snow sql -r "SECURITYADMIN" -q "REVOKE OWNERSHIP ON FUTURE DYNAMIC TABLES IN SCHEMA ${SNOWFLAKE_DOMAIN_CLONE_SANITIZED}.SCHEMACHANGE FROM ROLE ${SNOWFLAKE_DOMAIN_ORIGINAL}_PROXY_ADMIN;"
                snow sql -r "SECURITYADMIN" -q "GRANT OWNERSHIP ON FUTURE DYNAMIC TABLES IN SCHEMA ${SNOWFLAKE_DOMAIN_CLONE_SANITIZED}.SYNAPSE TO ROLE ${SNOWFLAKE_PROXY_ADMIN_ROLE};"
                snow sql -r "SECURITYADMIN" -q "GRANT OWNERSHIP ON FUTURE TASKS IN SCHEMA ${SNOWFLAKE_DOMAIN_CLONE_SANITIZED}.SYNAPSE_RAW TO ROLE ${SNOWFLAKE_PROXY_ADMIN_ROLE} COPY CURRENT GRANTS;"
                snow sql -r "SECURITYADMIN" -q "GRANT OWNERSHIP ON FUTURE DYNAMIC TABLES IN SCHEMA ${SNOWFLAKE_DOMAIN_CLONE_SANITIZED}.SCHEMACHANGE TO ROLE ${SNOWFLAKE_PROXY_ADMIN_ROLE};"


            - name: Give DE ownership of all objects in synapse, synapse_raw, schemachange
              shell: bash
              run: |
                # TODO: Why REVOKE current grants? This might cause trouble.
                snow sql -r "SECURITYADMIN" -q "GRANT OWNERSHIP ON DATABASE ROLE ${SNOWFLAKE_DOMAIN_CLONE_SANITIZED}.synapse_all_admin TO ROLE ${SNOWFLAKE_PROXY_ADMIN_ROLE} REVOKE CURRENT GRANTS;"
                snow sql -r "SECURITYADMIN" -q "GRANT DATABASE ROLE ${SNOWFLAKE_DOMAIN_CLONE_SANITIZED}.synapse_all_admin TO ROLE ${SNOWFLAKE_PROXY_ADMIN_ROLE};"

                snow sql -r "SECURITYADMIN" -q "GRANT OWNERSHIP ON DATABASE ROLE ${SNOWFLAKE_DOMAIN_CLONE_SANITIZED}.synapse_raw_all_admin TO ROLE ${SNOWFLAKE_PROXY_ADMIN_ROLE} REVOKE CURRENT GRANTS;"
                snow sql -r "SECURITYADMIN" -q "GRANT DATABASE ROLE ${SNOWFLAKE_DOMAIN_CLONE_SANITIZED}.synapse_raw_all_admin TO ROLE ${SNOWFLAKE_PROXY_ADMIN_ROLE};"

                snow sql -r "SECURITYADMIN" -q "GRANT OWNERSHIP ON DATABASE ROLE ${SNOWFLAKE_DOMAIN_CLONE_SANITIZED}.schemachange_all_admin TO ROLE ${SNOWFLAKE_PROXY_ADMIN_ROLE} REVOKE CURRENT GRANTS;"
                snow sql -r "SECURITYADMIN" -q "GRANT DATABASE ROLE ${SNOWFLAKE_DOMAIN_CLONE_SANITIZED}.schemachange_all_admin TO ROLE ${SNOWFLAKE_PROXY_ADMIN_ROLE};"


            - name: Grant USAGE on schemas to PROXY_ADMIN
              shell: bash
              run: |
                snow sql -r "SECURITYADMIN" -q "GRANT USAGE ON SCHEMA ${SNOWFLAKE_DOMAIN_CLONE_SANITIZED}.SYNAPSE TO ROLE ${SNOWFLAKE_PROXY_ADMIN_ROLE};"
                snow sql -r "SECURITYADMIN" -q "GRANT USAGE ON SCHEMA ${SNOWFLAKE_DOMAIN_CLONE_SANITIZED}.SYNAPSE_RAW TO ROLE ${SNOWFLAKE_PROXY_ADMIN_ROLE};"
                snow sql -r "SECURITYADMIN" -q "GRANT USAGE ON SCHEMA ${SNOWFLAKE_DOMAIN_CLONE_SANITIZED}.SCHEMACHANGE TO ROLE ${SNOWFLAKE_PROXY_ADMIN_ROLE};"


            - name: Grant USAGE on PROXY_ADMIN to DE
              shell: bash
              run: |
                snow sql -r "SECURITYADMIN" -q "GRANT ROLE ${SNOWFLAKE_PROXY_ADMIN_ROLE} TO ROLE ${SNOWFLAKE_CLONE_ROLE};"


            ########################################################################################################
            ########################################################################################################
            ##################################### RUNNING SCHEMACHANGE #############################################
            ########################################################################################################
            ########################################################################################################
            - name: Run schemachange on the clone as DATA_ENGINEER
              shell: bash
              run: |
                schemachange \
                -f synapse_data_warehouse \
                -a $SNOWFLAKE_ACCOUNT \
                -u $SNOWFLAKE_USER \
                -r $SNOWFLAKE_CLONE_ROLE \
                -w $SNOWFLAKE_WAREHOUSE \
                --config-folder synapse_data_warehouse \
                -v  # Enable verbose logging

       
    drop_clone:
      runs-on: ubuntu-latest
      if: github.event.pull_request.merged == true || github.event.action == 'closed'
      environment: dev
      env:
          # Establish the snowflake account credentials
          SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWSQL_ACCOUNT }}
          SNOWFLAKE_USER: ${{ secrets.SNOWSQL_USER }}
          SNOWFLAKE_PASSWORD: ${{ secrets.SNOWSQL_PWD }}

          # Establish the account roles to be used
          SNOWFLAKE_ADMIN_ROLE: "${{ vars.SNOWFLAKE_SYNAPSE_DATA_WAREHOUSE_DATABASE }}_ADMIN"

          # Establish the domains
          SNOWFLAKE_DOMAIN_CLONE: "${{ vars.SNOWFLAKE_SYNAPSE_DATA_WAREHOUSE_DATABASE }}_${{ github.head_ref }}"

          # Establish the warehouse
          SNOWFLAKE_WAREHOUSE: ${{ secrets.SNOWSQL_WAREHOUSE }}

      steps:

          - uses: actions/checkout@v4
          - uses: actions/setup-python@v4
            with:
              python-version: '3.10'

          - name: Configure Snowflake connection
            run: |
              # Make a temporary config file for the GH runner
              config_file=$(mktemp)

              # Config file for *ADMIN
              echo 'default_connection_name = "admin"' >> $config_file
              echo '[connections.admin]' >> $config_file
              echo "account = \"${SNOWFLAKE_ACCOUNT}\"" >> $config_file
              echo "user = \"${SNOWFLAKE_USER}\"" >> $config_file
              echo "role = \"${SNOWFLAKE_ADMIN_ROLE}\"" >> $config_file
              echo "password = \"${SNOWFLAKE_PASSWORD}\"" >> $config_file
              echo "warehouse = \"${SNOWFLAKE_WAREHOUSE}\"" >> $config_file
              echo 'authenticator = "SNOWFLAKE"' >> $config_file

              # Write config paths to environment
              echo "SNOWFLAKE_CONFIG_PATH=$config_file" >> $GITHUB_ENV

          - name: Install Snowflake CLI
            uses: Snowflake-Labs/snowflake-cli-action@v1.5
            with:
              default-config-file-path: ${{ env.SNOWFLAKE_CONFIG_PATH }}

          - name: Verify Snowflake CLI installation and connections
            run: |
              snow --version
              snow connection test -c admin

          - name: Sanitize Clone Name
            run: |
              SNOWFLAKE_DOMAIN_CLONE_SANITIZED="${SNOWFLAKE_DOMAIN_CLONE//[^a-zA-Z0-9_]/_}"
              echo "Clone name has been updated! The clone name will be: ${SNOWFLAKE_DOMAIN_CLONE_SANITIZED}"
              echo "SNOWFLAKE_DOMAIN_CLONE_SANITIZED=${SNOWFLAKE_DOMAIN_CLONE_SANITIZED}" >> $GITHUB_ENV

          # TODO: Add a step to delete the <CLONE-DOMAIN>_PROXY_ADMIN account role
          # TODO: When a clone and its objects are deleted, do the grants go away too? Check DATA_ENGINEER after drop_clone runs to confirm.

          - name: Drop the clone
            shell: bash
            run: |
              snow sql -r $SNOWFLAKE_ADMIN_ROLE -q "DROP DATABASE IF EXISTS ${SNOWFLAKE_DOMAIN_CLONE_SANITIZED};"